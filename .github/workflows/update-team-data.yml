name: Update Team Data

on:
  repository_dispatch:
    types: [update-team-data]
  workflow_dispatch:
  schedule:
    # Run daily at 2 AM UTC to keep data fresh
    - cron: '0 2 * * *'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-team-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Fetch latest team data from API
        id: fetch-data
        run: |
          echo "Fetching team data from API..."
          
          # Fetch data with timeout and error handling
          response=$(curl -s -w "%{http_code}" -o teamData.json --max-time 30 https://afaw-beta-api.onrender.com/api/teams)
          http_code="${response: -3}"
          
          if [ "$http_code" != "200" ]; then
            echo "❌ API request failed with status code: $http_code"
            exit 1
          fi
          
          # Validate JSON structure
          if ! jq empty teamData.json 2>/dev/null; then
            echo "❌ Invalid JSON response from API"
            exit 1
          fi
          
          # Check if data is an array and not empty
          array_length=$(jq length teamData.json)
          if [ "$array_length" -eq 0 ]; then
            echo "❌ API returned empty team data"
            exit 1
          fi
          
          echo "✅ Successfully fetched $array_length team members"
          echo "data_count=$array_length" >> $GITHUB_OUTPUT

      - name: Convert JSON to JS export
        run: |
          echo "Converting JSON to JavaScript module..."
          
          # Create the JavaScript file with proper formatting
          cat > src/data/teamData.js << 'EOF'
          // Auto-generated from API - Do not edit manually
          // Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          export const teamMembers = 
          EOF
          
          # Pretty print the JSON for better readability
          jq '.' teamData.json >> src/data/teamData.js
          
          echo ";" >> src/data/teamData.js
          
          echo "✅ JavaScript file generated successfully"

      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet src/data/teamData.js; then
            echo "No changes detected in team data"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in team data"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "🤖 Update team data from API"
          title: "🤖 Auto-update team data"
          body: |
            ## 🤖 Automated Team Data Update
            
            This PR updates the team data from the API.
            
            **Changes:**
            - Updated team member information
            - Data fetched from: https://afaw-beta-api.onrender.com/api/teams
            - Team members count: ${{ steps.fetch-data.outputs.data_count }}
            
            **Generated:** ${{ github.event_name == 'workflow_dispatch' && 'Manual trigger' || 'Scheduled update' }}
            
            ---
            *This PR was automatically generated by GitHub Actions*
          branch: update-team-data-${{ github.run_id }}
          delete-branch: true

      - name: Comment on PR
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `update-team-data-${context.runId}`
            });
            
            if (pulls.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pulls[0].number,
                body: `✅ Team data has been updated successfully!\n\n**Summary:**\n- Team members: ${{ steps.fetch-data.outputs.data_count }}\n- Last API fetch: ${new Date().toISOString()}`
              });
            }

      - name: Success message
        if: steps.check-changes.outputs.has_changes == 'false'
        run: |
          echo "✅ No changes needed - team data is up to date"
